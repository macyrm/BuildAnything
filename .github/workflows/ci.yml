name: Continuous Integration Build

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    build-and-test:
        runs-on: ubuntu-latest
        env:
            MODEL_PATH: ./models/xgb_alzheimer_classifier.joblib
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python Environment
              uses: actions/setup-python@v5
              with:
                  python-version: '3.10'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run Model Training Pipeline
              run: |
                mkdir -p models
                python src/data_prep.py
                python src/train_model.py
            
            - name: Force CPU-Only Torch for Docker Build
              run: |
                echo "Modifying requirements.txt to add PyTorch CPU Index."
                  ORIGINAL_REQS=$(grep -v '^torch' requirements.txt)
                  {
                      echo "--extra-index-url https://download.pytorch.org/whl/cpu"
                      echo "torch>=2.0.0" 
                      echo "$ORIGINAL_REQS"
                  } > requirements.tmp
                  
                  mv requirements.tmp requirements.txt
                  echo "--- Contents of requirements.txt after modification ---"
                  cat requirements.txt # Verify the change
                  
            - name: Build Docker Image
              run: docker build -t alz-screener-chatbot:latest .
            
            - name: Run Smoke Tests
              run: |
                  docker run -d --name test_app -p 8080:8080 --env MODEL_PATH=${{ env.MODEL_PATH }} alz-screener-chatbot:latest
                  
                  echo "Waiting for the application to start (15 seconds)..."
                  sleep 15
                  
                  python tests/smoke_tests.py

                  if [ $? -ne 0 ]; then
                      echo "Smoke tests failed!"
                      docker logs test_app
                      exit 1
                  fi
                  echo "Smoke tests passed!"